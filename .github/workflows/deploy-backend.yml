name: Deploy Backend

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Zip backend
      run: zip -r backend.zip .

    - name: Copy to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        source: "backend.zip"
        target: "/home/ec2-user/app-backend/"

    - name: Deploy on EC2
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ec2-user
        key: ${{ secrets.EC2_KEY }}
        script: |
          cd app-backend
          unzip -o backend.zip
          npm install --production
          
          ACTIVE=$(curl -s http://localhost/api/health | grep '5501' && echo blue || echo green)

          if [ "$ACTIVE" = "blue" ]; then
            pm2 restart kzarre-backend-green
            HEALTH=$(bash /home/ec2-user/health-check.sh http://127.0.0.1:5502/api/health)
            if [ "$HEALTH" = "OK" ]; then
              bash /home/ec2-user/switch-blue-green.sh backend green
            else
              pm2 restart kzarre-backend-blue
              exit 1
            fi
          else
            pm2 restart kzarre-backend-blue
            HEALTH=$(bash /home/ec2-user/health-check.sh http://127.0.0.1:5501/api/health)
            if [ "$HEALTH" = "OK" ]; then
              bash /home/ec2-user/switch-blue-green.sh backend blue
            else
              pm2 restart kzarre-backend-green
              exit 1
            fi
          fi

          pm2 save
